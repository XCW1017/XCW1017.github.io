
 <!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  
    <title>X先生独立博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="小饼干">
    

    
    <meta name="description" content="hello,every body!~">
<meta property="og:type" content="website">
<meta property="og:title" content="X先生独立博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="X先生独立博客">
<meta property="og:description" content="hello,every body!~">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="小饼干">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="X先生独立博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/%02.css">
<link rel="stylesheet" href="/.css">

<meta name="generator" content="Hexo 5.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="X先生独立博客" title="X先生独立博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="X先生独立博客">X先生独立博客</a></h1>
				<h2 class="blog-motto">爱生活爱编码</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/tags">标签</a></li>
					
						<li><a href="/categories">分类</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:example.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/12/08/雪花算法全局唯一ID/" title="实现全局唯一ID" itemprop="url">实现全局唯一ID</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="小饼干" target="_blank" itemprop="author">小饼干</a>
		
  <p class="article-time">
    <time datetime="2020-12-08T01:47:47.001Z" itemprop="datePublished"> Published 2020-12-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="集群高并发情况下如何保证分布式唯一ID全局生成"><a href="#集群高并发情况下如何保证分布式唯一ID全局生成" class="headerlink" title="集群高并发情况下如何保证分布式唯一ID全局生成"></a>集群高并发情况下如何保证分布式唯一ID全局生成</h2><blockquote>
<p>工程分布式部署，要求抗住高并发。并且生成的id是根据时间自增的</p>
</blockquote>
<h2 id="1-ID生成规则"><a href="#1-ID生成规则" class="headerlink" title="1.ID生成规则"></a>1.ID生成规则</h2><ul>
<li><strong>全局唯一：</strong><ul>
<li>不能出现重复ID号；</li>
</ul>
</li>
<li><strong>趋势递增：</strong><ul>
<li>在MySQL的innoDB.引擎中使用的是聚集索引，由于多数RDBMS使用B+tree的数据结构来存储索引数据，在主键的选择上面我们应该尽量使用有序的主键保证写入性能;</li>
</ul>
</li>
<li><strong>单调递增：</strong><ul>
<li>保证下一个大于上一个；例如事务版本号，IM增量消息，排序等排序要求;</li>
</ul>
</li>
<li><strong>信息安全：</strong><ul>
<li>如果ID是连续的，恶意用户的扒取工作就非常容易做了，直接按照顺序下载指定URL即可;如果是订单号就更危险了，竞争对手直接知道我们一天的单量。所以在一些应用场景下，需要ID无规则不规则，让竞争对手不好猜。</li>
</ul>
</li>
<li><strong>含时间戳：</strong><ul>
<li>可以在开发中快速了解分布式ID的生成时间。</li>
</ul>
</li>
</ul>
<h2 id="2-ID生成的系统可用性"><a href="#2-ID生成的系统可用性" class="headerlink" title="2.ID生成的系统可用性"></a>2.ID生成的系统可用性</h2><ul>
<li>高可用<ul>
<li>发一个获取分布式ID的请求，服务器就要保证99.999%的情况下给我创建一个唯一分布式ID</li>
</ul>
</li>
<li>低延迟<ul>
<li>发一个获取分布式ID的请求，服务器要快速，急速。</li>
</ul>
</li>
<li>高QPS<ul>
<li>例如一口气10万个创建分布式ID请求，服务器要扛得住压力。</li>
</ul>
</li>
</ul>
<h2 id="3-一般方案"><a href="#3-一般方案" class="headerlink" title="3.一般方案"></a>3.一般方案</h2><ol>
<li><p><strong>UUID：</strong></p>
<p>字符串太长，不自增，影响存储性能；</p>
</li>
<li><p><strong>数据库自增：</strong></p>
</li>
</ol>
<ol start="3">
<li><p><strong>Redis生成策略：</strong></p>
<p>通过使用incr，incrby实现，缺陷：维护多台Redis麻烦</p>
</li>
</ol>
<h2 id="4-SnowFlake雪花算法"><a href="#4-SnowFlake雪花算法" class="headerlink" title="4.SnowFlake雪花算法"></a>4.SnowFlake雪花算法</h2><ul>
<li><p>算法原理：生成一个64bit大小的整数</p>
<ol>
<li><p><strong>1bit</strong>，不用，因；为二进制中最高位是符号位，1表示负数，0表示正数。生成的id一般都是用整数，所以最高位固定为0；</p>
</li>
<li><p><strong>41bit-时间戳</strong>，用来记录时间戳，毫秒级。</p>
<p>41位可以表示2^{41}-1个数字，减1是因为可表示的数值范围是从0开始算的，而不是1。(2^{41})/(1000<em>60</em>60* 24*365)=69年</p>
</li>
<li><p><strong>10bit-工作机器id</strong>:用来记录工作机器id.</p>
<p>可以部署2^10=1024个节点，包括5位datacenterId和5位workerId；0-31表示不同的datecenterId和workerId；</p>
</li>
<li><p><strong>12bit-序列号</strong>，序列号，用来记录同毫秒内产生的不同id。</p>
<p>表示最大正整数2^12-1=4095，同一机器，同一毫秒内产生的ID序号；</p>
</li>
</ol>
</li>
</ul>
<p>使用糊涂工具使用雪花算法</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.hutool.cn/docs/#/">https://www.hutool.cn/docs/#/</a></p>
<ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hutool&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">hutool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">long</span> workerId = <span class="number">1</span>;<span class="comment">// 工作ID 0-31</span></span><br><span class="line">		<span class="keyword">long</span> datacenterId = <span class="number">1</span>;<span class="comment">// 数据中心ID 0-31</span></span><br><span class="line">		</span><br><span class="line">		Snowflake snowflake = IdUtil.createSnowflake(workerId, datacenterId);<span class="comment">//传入参数</span></span><br><span class="line">		<span class="keyword">long</span> nextId = snowflake.nextId();<span class="comment">//获得long类型Id</span></span><br><span class="line">		System.out.println(nextId);<span class="comment">//输出到控制台</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> nextId;<span class="comment">//返回到页面</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/12/08/SpringCloud/" title="SpringCloud介绍" itemprop="url">SpringCloud介绍</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="小饼干" target="_blank" itemprop="author">小饼干</a>
		
  <p class="article-time">
    <time datetime="2020-12-08T01:45:28.932Z" itemprop="datePublished"> Published 2020-12-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="1-注册中心"><a href="#1-注册中心" class="headerlink" title="1.    注册中心"></a>1.    注册中心</h1><h2 id="1-1-eureka"><a href="#1-1-eureka" class="headerlink" title="1.1 eureka"></a>1.1 eureka</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>Eureka是Netflix开发的服务发现框架，用于定位运行在AWS域中的中间层服务，以达到负载均衡和中间层服务故障转移的目的</p>
</blockquote>
<h3 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h3><blockquote>
<h4 id="服务端搭建："><a href="#服务端搭建：" class="headerlink" title="服务端搭建："></a>服务端搭建：</h4></blockquote>
<ul>
<li><p>​    引入Eureka-Server依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置eureka</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server7001</span></span><br><span class="line"><span class="attr">eureka:</span> </span><br><span class="line">  <span class="comment"># 每个EurekaServer 都包含一个EurekaClient，用于请求其他节同步 </span></span><br><span class="line">  <span class="attr">client:</span> </span><br><span class="line">     <span class="attr">registerWithEureka:</span> <span class="literal">true</span> <span class="comment">#fales表示不向注册中心注册自己，（单机方式）</span></span><br><span class="line">     <span class="attr">fetchRegistry:</span> <span class="literal">false</span> <span class="comment">#false表示自己就是注册中心，我的职责就是维护服务实例，并不需要去检查服务</span></span><br><span class="line">     <span class="attr">service-url:</span> <span class="comment">#设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">       <span class="attr">defaultZone:</span> <span class="string">http://localhost:7002/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p> <a href="http://localhost:7001进入控制台">http://localhost:7001进入控制台</a></p>
</li>
</ul>
<blockquote>
<h4 id="客户端搭建："><a href="#客户端搭建：" class="headerlink" title="客户端搭建："></a>客户端搭建：</h4></blockquote>
<ul>
<li><p>引入eureka客户端依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入eureka客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置客户端eureka</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ureka:</span> </span><br><span class="line">  <span class="comment"># 每个EurekaServer 都包含一个EurekaClient，用于请求其他节同步 </span></span><br><span class="line">  <span class="attr">client:</span> </span><br><span class="line">  <span class="comment">#表示是否将自己注册EurekaServer</span></span><br><span class="line">     <span class="attr">registerWithEureka:</span> <span class="literal">true</span> </span><br><span class="line">     <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true，单节点我所谓，集群必须设置为true才能配合ribbn使用负载均衡</span></span><br><span class="line">     <span class="attr">fetchRegistry:</span> <span class="literal">true</span> </span><br><span class="line">     <span class="attr">service-url:</span> </span><br><span class="line">     <span class="comment">#设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址，如果服务器是集群就用    ， 号分割地址</span></span><br><span class="line">       <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>服务端注解：@EnableEurekaServer</p>
<p>客户端注解：@EnableEurekaClient<br>                       @EnableDiscoveryClient</p>
</blockquote>
<h2 id="1-2-zookeeper"><a href="#1-2-zookeeper" class="headerlink" title="1.2 zookeeper"></a>1.2 zookeeper</h2><h3 id="介绍：-1"><a href="#介绍：-1" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>是一个分布式服务框架，zookeeper功能非常强大，可以实现诸如分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能。</p>
</blockquote>
<h3 id="用法：-1"><a href="#用法：-1" class="headerlink" title="用法："></a>用法：</h3><h4 id="zookeeper的安装"><a href="#zookeeper的安装" class="headerlink" title="zookeeper的安装"></a>zookeeper的安装</h4><p>​    <a target="_blank" rel="noopener" href="https://zookeeper.apache.org/releases.html#download%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5">https://zookeeper.apache.org/releases.html#download下载链接</a></p>
<ol>
<li><blockquote>
<h3 id="zookeeper依赖于jdk，需要安装jdk"><a href="#zookeeper依赖于jdk，需要安装jdk" class="headerlink" title="zookeeper依赖于jdk，需要安装jdk"></a>zookeeper依赖于jdk，需要安装jdk</h3></blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jdk</span><br><span class="line">/usr/java/jdk1<span class="number">.8</span><span class="number">.0_261</span>-amd64  #jdk默认安装路径</span><br></pre></td></tr></table></figure>

<p>配置环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;profile</span><br></pre></td></tr></table></figure>

<p>文件尾部添加信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;java&#x2F;jdk1.8.0_261-amd64</span><br><span class="line">export CLASSPATH&#x3D;$:CLASSPATH:$JAVA_HOME&#x2F;lib&#x2F;</span><br><span class="line">export PATH&#x3D;$PATH:$JAVA_HOME&#x2F;bin</span><br></pre></td></tr></table></figure>

<p>刷新环境配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;etc&#x2F;profile</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><blockquote>
<h3 id="安装zookeeper"><a href="#安装zookeeper" class="headerlink" title="安装zookeeper"></a>安装zookeeper</h3></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf zookeeper-3.4.9			#解压文件</span><br></pre></td></tr></table></figure>

<p>zookeeper的conf目录下zoo_sample.cfg文件复制为zoo.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp zoo_sample.cfg zoo.cfg</span><br></pre></td></tr></table></figure>

<p>​    </p>
<blockquote>
<p>发现：zoo.cfg文件发现</p>
<p>​        zookeeper默认端口    clientProt=2181</p>
<p>​        zookeeper数据位置    dataDir=/tmp/zookeeper</p>
</blockquote>
</li>
<li><blockquote>
<h2 id="启动zookeeper"><a href="#启动zookeeper" class="headerlink" title="启动zookeeper"></a>启动zookeeper</h2></blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#启动zookeeper</span><br><span class="line">.&#x2F;zkServer.sh start			</span><br><span class="line"></span><br><span class="line">#停止zookeeper</span><br><span class="line">.&#x2F;zkServer.sh stop</span><br><span class="line"></span><br><span class="line">#查看启动状态</span><br><span class="line">.&#x2F;zkServer.sh status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#进入客户端可查看服务</span><br><span class="line">.&#x2F;zkCli.sh </span><br><span class="line"></span><br><span class="line">#查看服务</span><br><span class="line">ls &#x2F;</span><br><span class="line"></span><br><span class="line">#获得服务</span><br><span class="line">get &#x2F;server&#x2F;master</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h4 id="项目搭建："><a href="#项目搭建：" class="headerlink" title="项目搭建："></a>项目搭建：</h4><ol>
<li><blockquote>
<h4 id="项目引入zookeeper"><a href="#项目引入zookeeper" class="headerlink" title="项目引入zookeeper"></a>项目引入zookeeper</h4></blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!--屏蔽默认自带的版本，否则会报错，然后导入自己的zookeeper3.4.9 版本 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 引入zookeeper --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><blockquote>
<h4 id="配置zookeeper服务地址"><a href="#配置zookeeper服务地址" class="headerlink" title="配置zookeeper服务地址"></a>配置zookeeper服务地址</h4></blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注册zookeeper到服务中心（192.168.0.201）</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer-srver</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="注意：-1"><a href="#注意：-1" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>启动类添加注解：@EnableDiscoveryClient</p>
<p>启动linux中的zookeeper：bin目录执行    ./zkServer.sh start    </p>
</blockquote>
<h2 id="1-3-consul"><a href="#1-3-consul" class="headerlink" title="1.3 consul"></a>1.3 consul</h2><h3 id="介绍：-2"><a href="#介绍：-2" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>是一个一个分布式的，高度可用的系统，而且开发使用都很简便。它提供了一个功能齐全的控制平面，主要特点是：服务发现、健康检查、键值存储、安全服务通信、多数据中心。</p>
</blockquote>
<h3 id="用法：-2"><a href="#用法：-2" class="headerlink" title="用法："></a>用法：</h3><h4 id="consul安装"><a href="#consul安装" class="headerlink" title="consul安装"></a>consul安装</h4><blockquote>
<p>安装地址：<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">https://www.consul.io/downloads.html</a></p>
</blockquote>
<h4 id="cmd命令"><a href="#cmd命令" class="headerlink" title="cmd命令"></a>cmd命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看版本号</span><br><span class="line">consul --version</span><br><span class="line"></span><br><span class="line">进入开发者模式</span><br><span class="line">consul agent -dev</span><br><span class="line"></span><br><span class="line">consul客户端</span><br><span class="line">http:&#x2F;&#x2F;localhost:8500</span><br></pre></td></tr></table></figure>



<h4 id="项目搭建：-1"><a href="#项目搭建：-1" class="headerlink" title="项目搭建："></a>项目搭建：</h4><ul>
<li><p>consul依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Consul依赖 --&gt;	</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">		&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!-- 健康监控 --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">		&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件设置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注册consul到服务中心（localhost）</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span> </span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="注意：-2"><a href="#注意：-2" class="headerlink" title="注意："></a>注意：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">启动类：	@EnableDiscoveryClient</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">控制台地址：	http:&#x2F;&#x2F;localhost:8500</span><br></pre></td></tr></table></figure>







<h2 id="1-4-nacos"><a href="#1-4-nacos" class="headerlink" title="1.4    nacos"></a>1.4    nacos</h2><blockquote>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/tags">https://github.com/alibaba/nacos/tags</a></p>
</blockquote>
<ol>
<li>解压后进入bin目录双击startup.cmd启动；</li>
<li><a target="_blank" rel="noopener" href="http://localhost:8848/nacos/index.html">http://localhost:8848/nacos/index.html</a> 进入控制台</li>
</ol>
<blockquote>
<p>注意：闪退问题解决办法：<a target="_blank" rel="noopener" href="https://www.pianshen.com/article/91891935970/">https://www.pianshen.com/article/91891935970/</a></p>
<ol>
<li>先用 <strong>Windows CMD</strong> 启动 <strong>startup.cmd</strong> 查看报错信息</li>
<li>用编辑器打开 <strong>startup.cmd</strong>删除相关参数删掉，重新启动</li>
<li>默认用户名密码都是nacos</li>
</ol>
</blockquote>
<h3 id="介绍：-3"><a href="#介绍：-3" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>Nacos 支持基于 DNS 和基于 RPC 的服务发现。Nacos 提供对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求。Nacos 支持传输层 (PING 或 TCP)和应用层 (如 HTTP、MySQL、用户自定义）的健康检查。</p>
</blockquote>
<h3 id="使用："><a href="#使用：" class="headerlink" title="使用："></a>使用：</h3><ul>
<li><p>消费者引入pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nacos服务中心</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-test</span>	<span class="comment">#服务名</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">      <span class="attr">discovery:</span> </span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span>	   <span class="comment">#nacos服务端地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#暴露监控</span></span><br><span class="line"><span class="attr">management:</span> </span><br><span class="line">  <span class="attr">endpoints:</span> </span><br><span class="line">    <span class="attr">web:</span> </span><br><span class="line">      <span class="attr">exposure:</span> </span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务访问  <a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></p>
</li>
</ul>
<h1 id="2-服务调用"><a href="#2-服务调用" class="headerlink" title="2.    服务调用"></a>2.    服务调用</h1><h2 id="2-1-ribbon-RestTemplate"><a href="#2-1-ribbon-RestTemplate" class="headerlink" title="2.1    ribbon+RestTemplate"></a>2.1    ribbon+RestTemplate</h2><h3 id="介绍：-4"><a href="#介绍：-4" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<h4 id="ribbon"><a href="#ribbon" class="headerlink" title="ribbon"></a>ribbon</h4></blockquote>
<blockquote>
<p>是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。</p>
</blockquote>
<blockquote>
<h4 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h4></blockquote>
<blockquote>
<p>RestTemplate 是从 Spring3.0 开始支持的一个 HTTP 请求工具，它提供了常见的REST请求方案的模版，例如 GET 请求、POST 请求、PUT 请求</p>
</blockquote>
<h3 id="用法：-3"><a href="#用法：-3" class="headerlink" title="用法："></a>用法：</h3><ul>
<li><p>创建两个微服务</p>
</li>
<li><p>消费者创建RestTemplate配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">httpConfig</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span><span class="comment">//生成一个可以访问HTTP地址的对象</span></span><br><span class="line">	<span class="meta">@LoadBalanced</span><span class="comment">//开启负载均衡：默认轮询</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>消费者controller使用RestTemplate远程访问生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsulController</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String Server_Url=<span class="string">&quot;http://producer-server&quot;</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	RestTemplate restTemplate;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/consumer/conslu&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">consluTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> restTemplate.getForObject(Server_Url+<span class="string">&quot;/conslu&quot;</span>, String.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="注意：-3"><a href="#注意：-3" class="headerlink" title="注意："></a>注意：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动类添加注解： @EnableDiscoveryClient</span><br><span class="line"></span><br><span class="line">消费者controller远程服务名要存在</span><br></pre></td></tr></table></figure>





<h2 id="2-2-Fegin-ribbon"><a href="#2-2-Fegin-ribbon" class="headerlink" title="2.2    Fegin+ribbon"></a>2.2    Fegin+ribbon</h2><h3 id="介绍：-5"><a href="#介绍：-5" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<h3 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h3></blockquote>
<blockquote>
<p>Feign是一种声明式、模板化的HTTP客户端。在Spring Cloud中使用Feign，可以做到使用HTTP请求访问远程服务，就像调用本地方法一样的，开发者完全感知不到这是在调用远程方法，更感知不到在访问HTTP请求。</p>
</blockquote>
<h3 id="用法：-4"><a href="#用法：-4" class="headerlink" title="用法："></a>用法：</h3><ul>
<li><p>引入openFegin依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- openfeign依赖 --&gt;</span>	</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置对hystrix的支持</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer-client</span> <span class="comment">#注册服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span>    <span class="comment">#注册中心端口</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment">#注册中心ip</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建service接口，指定服务名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;cloud-panment-service&quot;)</span> <span class="comment">// 服务名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeginService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//查询所有</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/findPaymentAll&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult <span class="title">findPaymentAll</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">//根据id查询</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/findPaymentById/&#123;id&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">findPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller调用service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	FeginService feginService;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//查询所有</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/consumer/findPaymentAll&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult <span class="title">findPaymentAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> feginService.findPaymentAll();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//根据id查询</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/consumer/findPaymentById/&#123;id&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">findPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> feginService.findPaymentById(id);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="注意：-4"><a href="#注意：-4" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>启动类：@EnableDiscoveryClient                    //让服务中心发现，该微服务<br>                @EnableFeignClients                        //扫描所有使用注解@FeignClient定义的feign客户端</p>
</blockquote>
<h2 id="2-3-ribbon负载均衡"><a href="#2-3-ribbon负载均衡" class="headerlink" title="2.3    ribbon负载均衡"></a>2.3    ribbon负载均衡</h2><h3 id="介绍：-6"><a href="#介绍：-6" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>可以指定负载均衡的模式；</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">实现IRule接口的类，实现修改模式（该接口的jar，在eureka下）</span><br><span class="line"></span><br><span class="line">1. com.netfix.loadbalancer.RoundRobinRule轮询</span><br><span class="line">2. com.netfix.loadbalancer.RandomRule随机</span><br><span class="line">3. com.netfix.loadbalancer.RetryRule 根据轮询，若失败进行重试，获取可用服务</span><br><span class="line">4. WeigdthResponseTimeRule 轮询的扩展，响应速度越快权重越高,越容易被选择</span><br><span class="line">5. BestAvailableRule  过滤掉有过故障记录的，然后访问并发量小的服务</span><br><span class="line">6. AvailabliltyFilteringRule  过滤掉现有故障的，在选择并发量小的服务</span><br><span class="line">7. ZoneAvoidanceRule 符合判断server所在区域的性能及其可用性</span><br></pre></td></tr></table></figure>



<h3 id="用法：-5"><a href="#用法：-5" class="headerlink" title="用法："></a>用法：</h3><ul>
<li><p>自定义负载均衡模式，配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomConfig</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> IRule <span class="title">randomRule</span><span class="params">()</span> </span>&#123;<span class="comment">//定义随机负载均衡</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="注意：-5"><a href="#注意：-5" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>启动类指定配置类：@RibbonClient(name = “CLOUD-PANMENT-SERVICE”, configuration = RandomConfig.class)</p>
<p>创建的配置类位置不能被启动类扫描到，否则所有客户端均使用该配置</p>
</blockquote>
<h2 id="2-4-Fegin延迟等待"><a href="#2-4-Fegin延迟等待" class="headerlink" title="2.4    Fegin延迟等待"></a>2.4    Fegin延迟等待</h2><blockquote>
<p>Fegin的默认等待时间为1s，我们设置为5s</p>
</blockquote>
<h3 id="用法：-6"><a href="#用法：-6" class="headerlink" title="用法："></a>用法：</h3><ul>
<li><p>只需在yml中配日志ribbon</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置feign超时时间，openFeign默认支持ribbon</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="comment">#指的是建立连接所用的时间，适用于网络正常的情况下，两端连接所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment">#指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>





</li>
</ul>
<h2 id="2-5-Fegin日志级别"><a href="#2-5-Fegin日志级别" class="headerlink" title="2.5    Fegin日志级别"></a>2.5    Fegin日志级别</h2><h3 id="介绍：-7"><a href="#介绍：-7" class="headerlink" title="介绍："></a>介绍：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">日志级别共四种：</span><br><span class="line"> none：默认，不显示任何信息	</span><br><span class="line"> BASIC：仅记录请求方法，URL，响应状态码及时间</span><br><span class="line"> HEADERS：除了BASIC外，还有请求和响应的头信息</span><br><span class="line"> Full：除了HEADERS外，还有请求的正文和元数据</span><br></pre></td></tr></table></figure>



<h3 id="用法：-7"><a href="#用法：-7" class="headerlink" title="用法："></a>用法：</h3><ul>
<li><p>设置日志输出级别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#设置指定包下日志输出级别</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  level: </span><br><span class="line">    #com.xcw.service包下的输出级别</span><br><span class="line">    com.xcw.service: debug </span><br></pre></td></tr></table></figure>
</li>
<li><p>创建日志级别配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingConfig</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span><span class="comment">//设置日志级别，返回响应头，元数据</span></span><br><span class="line">	<span class="keyword">public</span> Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








</li>
</ul>
<h1 id="3-服务降级"><a href="#3-服务降级" class="headerlink" title="3.  服务降级"></a>3.  服务降级</h1><h2 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h2><h3 id="介绍：-8"><a href="#介绍：-8" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>源自netflix公司，Hystrix是一个分布式依赖库，通过隔离服务之间的访问点、停止级联失败和提供回退选项来实现这一点，所有这些都可以提高系统的整体弹性</p>
</blockquote>
<h3 id="使用：-1"><a href="#使用：-1" class="headerlink" title="使用："></a>使用：</h3><h4 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h4><blockquote>
<p>如果某个目标服务调用慢或者有大量超时，此时，熔断该服务的调用，对于后续调用请求，不在继续调用目标服务，直接返回，快速释放资源。如果目标服务情况好转则恢复调用</p>
</blockquote>
<ul>
<li><p>创建一个eureka项目添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8906</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">futurecloud-clent</span></span><br><span class="line"><span class="comment">#将此服务注册到eureka 服务上</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">  	<span class="attr">fetch-registry:</span> <span class="literal">true</span> <span class="comment">#是否从EurekaServer中抓取信息，默认true，集群下必须为true配合ribbon</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>  <span class="comment">#将自己注册进服务中心</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7002/eureka/,http://localhost:7001/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>  <span class="comment">#将注册到eureka服务的实例使用ip地址</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类Fegin接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;futurecloud-server&quot;)</span>   <span class="comment">//通过注解指定依赖服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeignClientInterfaces</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hystrix&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hystrixTest</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FuturecloudHystrixController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> FeignClientInterfaces feignClientInterfaces;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用Hystrix熔断器，当调用findUserById失败后，调用forbackFindUserById方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;forbackFindUserById&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hystrix&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hystrixTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">4</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hystrix正常&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">forbackhystrixTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;熔断处理&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类开启hystrix，fegin支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span><span class="comment">//声明为eureka 客户端</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">//启动Feign</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span> <span class="comment">//启动熔断降级</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FuturecloudHystrixApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span>  <span class="comment">//相当于xml中的bean标签，主要是用于调用当前方法获取到指定对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(FuturecloudHystrixApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h4 id="全局降级处理一"><a href="#全局降级处理一" class="headerlink" title="全局降级处理一"></a>全局降级处理一</h4><ul>
<li><p>控制器添加，指定默认处理方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultProperties(defaultFallback = &quot;defaultMethod&quot;)</span></span><br></pre></td></tr></table></figure>





</li>
</ul>
<h4 id="全局降级处理二"><a href="#全局降级处理二" class="headerlink" title="全局降级处理二"></a>全局降级处理二</h4><ul>
<li><p>消费者feginclient接口中指定处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;COLOUD-HYSTRIX-SERVICE&quot;,fallback = HystrixFallBack.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HystrixService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/hystrix&quot;)</span><span class="comment">//正常访问</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">payment</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/hystrix/timeout&quot;)</span><span class="comment">//超出时间</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">paymentTimeout</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/hystrix/serviceFuce/&#123;id&#125;&quot;)</span><span class="comment">//服务熔断</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">serviceFuce</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span></span>; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>实现接口进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixFallBack</span> <span class="keyword">implements</span> <span class="title">HystrixService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">payment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hystrix fallback&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">paymentTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hystrix fallback&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">serviceFuce</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hystrix serviceFuce&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类开启fegin和hystrix</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span>			<span class="comment">//扫描feign</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span>		<span class="comment">//开启熔断降级</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springcloud12HystrixConsumer80FeginApplication</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Springcloud12HystrixConsumer80FeginApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="dashboard仪表盘"><a href="#dashboard仪表盘" class="headerlink" title="dashboard仪表盘"></a>dashboard仪表盘</h4><blockquote>
<p>监控熔断降级</p>
</blockquote>
<ul>
<li><p>pom导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml仅配置端口</p>
</li>
<li><p>启动类开启服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span><span class="comment">//开启服务熔断</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span> <span class="comment">//开启hystrix仪表盘管理</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springcloud13HystrixDashboard9001Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Springcloud13HystrixDashboard9001Application.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>被监控的服务，启动类添加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">	public ServletRegistrationBean	getServlet()&#123;</span><br><span class="line">		HystrixMetricsStreamServlet streamServlet &#x3D; new HystrixMetricsStreamServlet();</span><br><span class="line">		ServletRegistrationBean registrationBean &#x3D; new ServletRegistrationBean(streamServlet);</span><br><span class="line">		registrationBean.setLoadOnStartup(1);</span><br><span class="line">		registrationBean.addUrlMappings(&quot;&#x2F;hystrix.stream&quot;);</span><br><span class="line">		registrationBean.setName(&quot;HystrixMetricsStreamServlet&quot;);</span><br><span class="line">		return registrationBean;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问仪表盘：<a target="_blank" rel="noopener" href="http://localhost:9001/hystrix">http://localhost:9001/hystrix</a> 添加需要监控的项目：   http:localhost:port/hystrix.stream</p>
</li>
</ul>
<h3 id="注意：-6"><a href="#注意：-6" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>配置文件要开启hystrix支持：feign:  hystrix: enabled: true</p>
<p>仪表盘服务被监控必须要加配置</p>
</blockquote>
<h2 id="Sentinl"><a href="#Sentinl" class="headerlink" title="Sentinl"></a>Sentinl</h2><p>​        sentinel下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/tags">https://github.com/alibaba/Sentinel/tags</a></p>
<p>​        中文文档：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</a></p>
<p>​        使用：下载后在所在目录打开cmd，输入 java -jar  sentinel-dashboard-1.8.0.jar</p>
<h3 id="介绍：-9"><a href="#介绍：-9" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>可以从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性，消息削峰 谷、集群流量控制、实时熔断下游不可用应用等</p>
</blockquote>
<h3 id="用法：-8"><a href="#用法：-8" class="headerlink" title="用法："></a>用法：</h3><ul>
<li><p>引入sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--去除jackson-dataformat-xml，否则会返回xml文件，而不是JSON--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置sentinel环境</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">      <span class="attr">discovery:</span> </span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">##访问本地</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">#配置sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span> <span class="comment">#默认8719，加入被占用会自动从8719开始依次+1扫描直至找到未被占用的端口</span></span><br><span class="line"><span class="comment">#      datasource:</span></span><br><span class="line"><span class="comment">#        ds1: </span></span><br><span class="line"><span class="comment">#          nacos:</span></span><br><span class="line"><span class="comment">#            server-addr: localhost:8848</span></span><br><span class="line"><span class="comment">#            data-id: cloudalibaba-sentinel-service</span></span><br><span class="line"><span class="comment">#            group-id: DEFAULT_GROUP</span></span><br><span class="line"><span class="comment">#            data-type: json #编写这个值提示红色❌号但可以运行，不写启动服务报错</span></span><br><span class="line"><span class="comment">#            rule-type: flow #编写这个值提示红色❌号但可以运行，不写启动服务报错           </span></span><br><span class="line">           </span><br><span class="line"><span class="attr">management:</span> </span><br><span class="line">  <span class="attr">endpoints:</span> </span><br><span class="line">    <span class="attr">web:</span> </span><br><span class="line">      <span class="attr">exposure:</span> </span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#激活sentinel对feign的支持</span></span><br><span class="line"><span class="comment">#feign:</span></span><br><span class="line"><span class="comment">#  sentinel:</span></span><br><span class="line"><span class="comment">#    enabled: true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建控制器，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentineController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/sentA&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">sentA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;sentA----&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/sentB&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">sentB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;sentB----&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问：localhost:8080进入sentinel控制台</p>
</li>
</ul>
<h4 id="1-流控规则"><a href="#1-流控规则" class="headerlink" title="1 流控规则"></a>1 流控规则</h4><ol>
<li>直接默认：达到阈值直接返回</li>
<li>关联：当关联的资源达到阈值，限流自己</li>
<li>链路：只记录指定链路上的流量 如：a-b-c 对其中一个进行流控，该链路都会有流控；</li>
</ol>
<p>####</p>
<h4 id="2-流控效果"><a href="#2-流控效果" class="headerlink" title="2 流控效果"></a>2 流控效果</h4><ol>
<li><p>快速失败：直接失败</p>
</li>
<li><p>warm up：根据冷因子加载（默认3），从阈值中经过预热时长，达到设定的Qps阈值；</p>
<p>公式： 10/3=3     刚开始为一秒3个限流，三秒后阈值达到10限流</p>
<p>常用于秒杀</p>
</li>
<li><p>排队等待：匀速排队，让请求匀速的速度通过，阈值类型必须设置QPS，否则无效;</p>
</li>
</ol>
<h4 id="3-降级使用"><a href="#3-降级使用" class="headerlink" title="3 降级使用"></a>3 降级使用</h4><p>熔断降级规则（DegradeRule）包含下面几个重要的属性：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>resource</td>
<td>资源名，即规则的作用对象</td>
<td></td>
</tr>
<tr>
<td>grade</td>
<td>熔断策略，支持慢调用比例/异常比例/异常数策略</td>
<td>慢调用比例</td>
</tr>
<tr>
<td>count</td>
<td>慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例/异常数模式下为对应的阈值</td>
<td></td>
</tr>
<tr>
<td>timeWindow</td>
<td>熔断时长，单位为 s</td>
<td></td>
</tr>
<tr>
<td>minRequestAmount</td>
<td>熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）</td>
<td>5</td>
</tr>
<tr>
<td>statIntervalMs</td>
<td>统计时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）</td>
<td>1000 ms</td>
</tr>
<tr>
<td>slowRatioThreshold</td>
<td>慢调用比例阈值，仅慢调用比例模式有效（1.8.0 引入）</td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>慢调用比例 ：设置慢调用RT，请求的响应时间大于后称为慢调用； 当一秒内大于最小请求数，且形成慢调用的比例大于阈值，接下来熔断时长内请求熔断；</li>
<li>异常比例：一秒内请求数大于最小请求数，且异常比例大于阈值，接下来会进入熔断；</li>
<li>异常数：一秒内异常请求超过阈值，进行熔断;</li>
</ol>
<h4 id="4-热点限流"><a href="#4-热点限流" class="headerlink" title="4 热点限流"></a>4 热点限流</h4><blockquote>
<p>中文使用文档：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81">https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81</a></p>
</blockquote>
<ol>
<li><p>在springcloud25-alibaba-sentinel8401项目的controller中添加方法以及降级方法</p>
<p>方法上添加@SentinelResource注解；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 热点限流</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sentC&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;sentC&quot;,blockHandler = &quot;sentCMethod&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">SentC</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;, required = false)</span> String p1</span></span></span><br><span class="line"><span class="function"><span class="params">					,<span class="meta">@RequestParam(value = &quot;p2&quot;, required = false)</span> String p2)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;sentc&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sentCMethod</span><span class="params">(String p1,String p2,BlockException exception)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;sentC被限流了&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sentinel控制台添加热点规则：参数索引指向0，表示对第一个参数进行限流；</p>
</li>
<li><p>访问<a target="_blank" rel="noopener" href="http://localhost:8401/sentC?p1=a%E8%BE%BE%E5%88%B0%E9%98%88%E5%80%BC%E6%8C%87%E5%90%91%E9%99%90%E6%B5%81%E6%96%B9%E6%B3%95%EF%BC%9B">http://localhost:8401/sentC?p1=a达到阈值指向限流方法；</a></p>
</li>
</ol>
<blockquote>
<h3 id="注意：blockHandler指向的方法中一定要指定参数；"><a href="#注意：blockHandler指向的方法中一定要指定参数；" class="headerlink" title="注意：blockHandler指向的方法中一定要指定参数；"></a>注意：blockHandler指向的方法中一定要指定参数；</h3><h3 id="SentinelResource只处理sentinel控制台规则，不处理运行时异常"><a href="#SentinelResource只处理sentinel控制台规则，不处理运行时异常" class="headerlink" title="SentinelResource只处理sentinel控制台规则，不处理运行时异常"></a>SentinelResource只处理sentinel控制台规则，不处理运行时异常</h3></blockquote>
<h4 id="5-系统规则"><a href="#5-系统规则" class="headerlink" title="5 系统规则"></a>5 系统规则</h4><p>​    系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<h4 id="6-SentinelResource属性"><a href="#6-SentinelResource属性" class="headerlink" title="6 SentinelResource属性"></a>6 SentinelResource属性</h4><ul>
<li>value：资源名</li>
<li>blockHandler：兜底方法</li>
<li>blockHandlerClass：兜底方法类（该类中处理方法均为静态方法）</li>
</ul>
<h4 id="7-服务熔断"><a href="#7-服务熔断" class="headerlink" title="7 服务熔断"></a>7 服务熔断</h4><p>sentinelResource的参数</p>
<ul>
<li>fallback处理运行时异常</li>
<li>blockHandler负责控制台违规</li>
</ul>
<blockquote>
<h3 id="实现：sentinel-ribbon-fegin消费者降级处理"><a href="#实现：sentinel-ribbon-fegin消费者降级处理" class="headerlink" title="实现：sentinel+ribbon+fegin消费者降级处理;"></a>实现：sentinel+ribbon+fegin消费者降级处理;</h3></blockquote>
<ol>
<li><blockquote>
<h3 id="服务调用方pom"><a href="#服务调用方pom" class="headerlink" title="服务调用方pom"></a>服务调用方pom</h3></blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--去除jackson-dataformat-xml，否则会返回xml文件，而不是JSON--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><blockquote>
<h3 id="yml配置注册中心，sentinel中心，激活feign支持"><a href="#yml配置注册中心，sentinel中心，激活feign支持" class="headerlink" title="yml配置注册中心，sentinel中心，激活feign支持"></a>yml配置注册中心，sentinel中心，激活feign支持</h3></blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">      <span class="attr">discovery:</span> </span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">##访问本地</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">##访问本地</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span> <span class="comment">#默认8719，加入被占用会自动从8719开始依次+1扫描直至找到未被占用的端口</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">management:</span> </span><br><span class="line">  <span class="attr">endpoints:</span> </span><br><span class="line">    <span class="attr">web:</span> </span><br><span class="line">      <span class="attr">exposure:</span> </span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment">#激活sentinel对feign的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><blockquote>
<h3 id="创建封装返回json的实体类"><a href="#创建封装返回json的实体类" class="headerlink" title="创建封装返回json的实体类"></a>创建封装返回json的实体类</h3></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payment</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String serial;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 项目如果前后端分离开发，传给前端一个json</span></span><br><span class="line"><span class="comment"> * 那么此类是json格式的封装体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResult</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Integer code;</span><br><span class="line">	<span class="keyword">private</span> String message;</span><br><span class="line">	<span class="keyword">private</span> T data;<span class="comment">//传到前端的实体类数据</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CommonResult</span><span class="params">(Integer code,String message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.code=code;</span><br><span class="line">		<span class="keyword">this</span>.message=message;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><blockquote>
<h3 id="service创建fegin接口"><a href="#service创建fegin接口" class="headerlink" title="service创建fegin接口"></a>service创建fegin接口</h3></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xcw.entity.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.xcw.entity.Payment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;http://nacos-payment-provider&quot;, fallback = FeignServiceFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/paymentSql/&#123;id&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSql</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><blockquote>
<h3 id="兜底实现类FeignServiceFallback-java"><a href="#兜底实现类FeignServiceFallback-java" class="headerlink" title="兜底实现类FeignServiceFallback.java"></a>兜底实现类FeignServiceFallback.java</h3></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xcw.entity.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.xcw.entity.Payment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignServiceFallback</span> <span class="keyword">implements</span> <span class="title">FeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSql</span><span class="params">(Long id)</span> </span>&#123;<span class="comment">//兜底方法</span></span><br><span class="line">		CommonResult&lt;Payment&gt; result = <span class="keyword">new</span> CommonResult&lt;Payment&gt;(<span class="number">444</span>, <span class="string">&quot;消费者fallback&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><blockquote>
<h3 id="controller调用service"><a href="#controller调用service" class="headerlink" title="controller调用service"></a>controller调用service</h3></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.annotation.SentinelResource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.xcw.entity.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.xcw.entity.Payment;</span><br><span class="line"><span class="keyword">import</span> com.xcw.service.FeignService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span><span class="comment">//自动注入调用服务接口</span></span><br><span class="line">	FeignService feginService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(value = &quot;/consumer/paymentSql/&#123;id&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">paymentSql</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">		CommonResult&lt;Payment&gt; result = feginService.paymentSql(id);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><blockquote>
<h3 id="启动类开启fegin客户端扫描"><a href="#启动类开启fegin客户端扫描" class="headerlink" title="启动类开启fegin客户端扫描"></a>启动类开启fegin客户端扫描</h3></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springcloud28AlibabaConsumer84Application</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Springcloud28AlibabaConsumer84Application.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><blockquote>
<h3 id="启动客户端服务端：-访问http-localhost-84-consumer-paymentSql-1"><a href="#启动客户端服务端：-访问http-localhost-84-consumer-paymentSql-1" class="headerlink" title="启动客户端服务端： 访问http://localhost:84/consumer/paymentSql/1"></a>启动客户端服务端： 访问<a target="_blank" rel="noopener" href="http://localhost:84/consumer/paymentSql/1">http://localhost:84/consumer/paymentSql/1</a></h3><h3 id="客户端服务关闭会启用兜底方法"><a href="#客户端服务关闭会启用兜底方法" class="headerlink" title="客户端服务关闭会启用兜底方法"></a>客户端服务关闭会启用兜底方法</h3></blockquote>
</li>
</ol>
<h4 id="8-sentinel持久化"><a href="#8-sentinel持久化" class="headerlink" title="8 sentinel持久化"></a>8 sentinel持久化</h4><ul>
<li>resourec:资源名</li>
<li>limitApp：来源应用;</li>
<li>grade：阈值类型，0表示线程数，1表示QPS。</li>
<li>count：单击阈值</li>
<li>strategy：流控模式，0直接，1关联，2链路</li>
<li>contorlBehavior：流控效果，0快速失败，1WarmUp，2表示排队等待；</li>
<li>clusterMode：是否集群</li>
</ul>
<blockquote>
<h3 id="修改springcloud25-alibaba-sentinel8401"><a href="#修改springcloud25-alibaba-sentinel8401" class="headerlink" title="修改springcloud25-alibaba-sentinel8401"></a>修改springcloud25-alibaba-sentinel8401</h3></blockquote>
<ol>
<li><p>pom引入</p>
</li>
<li><pre><code class="xml">&lt;!--持久化用到  --&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;
            &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;
         &lt;/dependency&gt;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3. yml开启持久化</span><br><span class="line"></span><br><span class="line">   &#96;&#96;&#96;yml</span><br><span class="line">   spring: </span><br><span class="line">     application: </span><br><span class="line">       name: cloudalibaba-sentinel-service</span><br><span class="line">     cloud: </span><br><span class="line">       nacos: </span><br><span class="line">         discovery: </span><br><span class="line">           server-addr: localhost:8848 ##访问本地</span><br><span class="line">       sentinel:</span><br><span class="line">         transport:</span><br><span class="line">           dashboard: localhost:8080 #配置sentinel dashboard地址</span><br><span class="line">           port: 8719 #默认8719，加入被占用会自动从8719开始依次+1扫描直至找到未被占用的端口</span><br><span class="line">         datasource:</span><br><span class="line">           ds1: </span><br><span class="line">             nacos:</span><br><span class="line">               server-addr: localhost:8848</span><br><span class="line">               data-id: cloudalibaba-sentinel-service</span><br><span class="line">               group-id: DEFAULT_GROUP</span><br><span class="line">               data-type: json #编写这个值提示红色❌号但可以运行，不写启动服务报错</span><br><span class="line">               rule-type: flow #编写这个值提示红色❌号但可以运行，不写启动服务报错</span><br><span class="line">               </span><br><span class="line">              </span><br></pre></td></tr></table></figure></code></pre>
</li>
<li><p>开启项目访问：<a target="_blank" rel="noopener" href="http://localhost:8401/sentB">http://localhost:8401/sentB</a></p>
</li>
<li><p>新增流控</p>
</li>
<li><p>新增配置文件，类型json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">&quot;resource&quot;:&quot;&#x2F;rateLimit&#x2F;byUrl&quot;,</span><br><span class="line">&quot;limitApp&quot;:&quot;default&quot;,</span><br><span class="line">&quot;grade&quot;:1,</span><br><span class="line">&quot;count&quot;:1,</span><br><span class="line">&quot;strategy&quot;:0,</span><br><span class="line">&quot;controlBehavior&quot;:0,</span><br><span class="line">&quot;clusterMode&quot;:false</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启项目进入sentinel发现已经实现持久化</p>
</li>
</ol>
<h3 id="注意：-7"><a href="#注意：-7" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>sentinelResource的属性：</p>
<ul>
<li>fallback处理运行时异常</li>
<li>blockHandler负责控制台违规</li>
</ul>
</blockquote>
<h1 id="4-服务网关"><a href="#4-服务网关" class="headerlink" title="4.    服务网关"></a>4.    服务网关</h1><h2 id="Gateway介绍："><a href="#Gateway介绍：" class="headerlink" title="Gateway介绍："></a>Gateway介绍：</h2><blockquote>
<p>gateway 代替了zuul，SpringCloud Gateway 使用的Webflux中的reactor-netty响应式编程组件，底层使用Netty通讯框架</p>
<p>顾名思义，是统一管理API的一个网络关口、通道，是整个微服务平台所有请求的唯一入口，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能；</p>
</blockquote>
<blockquote>
<h3 id="三大特点：路由、断言、过滤器"><a href="#三大特点：路由、断言、过滤器" class="headerlink" title="三大特点：路由、断言、过滤器"></a>三大特点：路由、断言、过滤器</h3></blockquote>
<h2 id="使用：-2"><a href="#使用：-2" class="headerlink" title="使用："></a>使用：</h2><ul>
<li><p>创建网关微服务，要将自身web注释掉否则报错</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">	&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">&lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 微服务 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置网关信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span> <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启从注册中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_routh #路由的ID，没有固定规则，但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-panment-service</span> <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/findPaymentAll/**</span> <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"><span class="comment">#            - After=2020-09-09T17:25:38.551+08:00[Asia/Shanghai] #在这个时间之后才能访问lb</span></span><br><span class="line"><span class="comment">#            - Cookie=username,lsp #cookie中带有username值为lsp</span></span><br><span class="line"><span class="comment">#            - Header=X-Request-Id,\d+  #请求头要有X-Request-Id属性并且值为整数的正则表达式</span></span><br><span class="line"><span class="comment">#            - Host=**.lsp.com #接收一组参数，一组匹配的域名列表，它通过参数中的主机地址作为匹配规则</span></span><br><span class="line"><span class="comment">#            - Method=GET  #只能是GET请求才可以</span></span><br><span class="line"><span class="comment">#            - Query=username,\d+ #要求参数名username并且值还要是整数才能路由</span></span><br><span class="line"><span class="attr">eureka:</span> </span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> </span><br><span class="line"> 	 <span class="comment">#表示是否将自己注册EurekaServer</span></span><br><span class="line">     <span class="attr">registerWithEureka:</span> <span class="literal">true</span> </span><br><span class="line">     <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true，单节点我所谓，集群必须设置为true才能配合ribbn使用负载均衡</span></span><br><span class="line">     <span class="attr">fetchRegistry:</span> <span class="literal">true</span> </span><br><span class="line">     <span class="attr">service-url:</span> </span><br><span class="line">       <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类开启服务中心发现</p>
</li>
<li><p>访问网关的断言地址会匹配服务：<a target="_blank" rel="noopener" href="http://localhost9527/findPaymentAll">http://localhost9527/findPaymentAll</a> </p>
</li>
</ul>
<h2 id="配置类使用网关"><a href="#配置类使用网关" class="headerlink" title="配置类使用网关"></a>配置类使用网关</h2><ul>
<li><p>创建网关配置类：访问<a target="_blank" rel="noopener" href="http://localhost:9527/guonei%E6%97%B6%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E5%88%B0https://news.baidu.com/guonei">http://localhost:9527/guonei时会自动转发到https://news.baidu.com/guonei</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span><span class="comment">//网关配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GateWayConfig</span> </span>&#123;</span><br><span class="line">	<span class="comment">//置了一个id为route-name的路由规则</span></span><br><span class="line">	<span class="comment">//当访问地址为http://localhost:9527/guonei时会自动转发到https://news.baidu.com/guonei</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">		RouteLocatorBuilder.Builder routes = builder.routes();</span><br><span class="line">		routes.route(<span class="string">&quot;path_xcw&quot;</span>, r -&gt; r.path(<span class="string">&quot;/guonei&quot;</span>).uri(<span class="string">&quot;https://news.baidu.com/guonei&quot;</span>)).build();</span><br><span class="line">		<span class="keyword">return</span> routes.build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="网关断言"><a href="#网关断言" class="headerlink" title="网关断言"></a>网关断言</h2><blockquote>
<h4 id="获取全格式时间"><a href="#获取全格式时间" class="headerlink" title="获取全格式时间"></a>获取全格式时间</h4></blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前时间工具类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZonedDateTimeTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ZonedDateTime now = ZonedDateTime.now();</span><br><span class="line">		System.out.println(now);</span><br><span class="line">		<span class="comment">//2020-10-20T16:18:22.095+08:00[Asia/Shanghai]</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<blockquote>
<h4 id="有效期"><a href="#有效期" class="headerlink" title="有效期"></a>有效期</h4></blockquote>
<p>​    -  After=2020-10-20T16:18:22.095+08:00[Asia/Shanghai]                                 #在此时间后有效</p>
<p>​    -  Before=2020-10-20T16:18:22.095+08:00[Asia/Shanghai]                             #在此时间前有效</p>
<p>​    -  Between=时间一,时间二                                                                                      #在此时间之间有效</p>
<blockquote>
<h5 id="携带cookie："><a href="#携带cookie：" class="headerlink" title="携带cookie："></a>携带cookie：</h5></blockquote>
<p>​    - Cookie=username,xcw                                                                                        #cookie中带有username值为xcw</p>
<p>​    cmd访问：        curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> –cookie “username=xcw”</p>
<blockquote>
<h5 id="请求头信息设置："><a href="#请求头信息设置：" class="headerlink" title="请求头信息设置："></a>请求头信息设置：</h5></blockquote>
<p>​    - Header=X-Request-Id,\d+                                                                                #请求头要有X-Request-Id属性并且值为整数的正则表达式</p>
<p>​    cmd访问：        curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> -H “X-Request-Id:123”</p>
<blockquote>
<h4 id="Host配置："><a href="#Host配置：" class="headerlink" title="Host配置："></a>Host配置：</h4></blockquote>
<p>​    - Host=**.xcw.com                                                 #接收一组参数，一组匹配的域名列表，它通过参数中的主机地址作为匹配规则</p>
<p>​    cmd访问：        curl <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a>     -H  “HOST:<a target="_blank" rel="noopener" href="http://www.xcw.com&quot;/">www.xcw.com&quot;</a></p>
<blockquote>
<h4 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h4></blockquote>
<p>​    - Method=GET                                                          #只能是GET请求才可以</p>
<p>​    </p>
<blockquote>
<h4 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h4></blockquote>
<p>​    - Query=username,\d+                                         #要求参数名username并且值还要是整数才能路由</p>
<p>​    curl  <a target="_blank" rel="noopener" href="http://localhost:9527/payment/lb?username=123">http://localhost:9527/payment/lb?username=123</a></p>
<h2 id="网关过滤"><a href="#网关过滤" class="headerlink" title="网关过滤"></a>网关过滤</h2><ul>
<li><p>过滤器实现GlobalFilter，Ordered接口（配置没有携带name参数则直接返回）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeteWayFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> <span class="comment">// 过滤内容</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 获取请求参数为name的</span></span><br><span class="line">		String name = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;用户为null，非法用户----------&quot;</span>);</span><br><span class="line">			<span class="comment">//设置响应状态</span></span><br><span class="line">			exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">			<span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//跳到下一个过滤器</span></span><br><span class="line">		<span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> <span class="comment">// 多个过滤器顺序</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





</li>
</ul>
<h1 id="5-配置中心"><a href="#5-配置中心" class="headerlink" title="5.    配置中心"></a>5.    配置中心</h1><h2 id="介绍：-10"><a href="#介绍：-10" class="headerlink" title="介绍："></a>介绍：</h2><blockquote>
<h4 id="方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件，在Spring-Cloud中，有分布式配置中心组件spring-cloud-config-，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中"><a href="#方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件，在Spring-Cloud中，有分布式配置中心组件spring-cloud-config-，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中" class="headerlink" title="方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件，在Spring Cloud中，有分布式配置中心组件spring cloud config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中"></a>方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件，在Spring Cloud中，有分布式配置中心组件spring cloud config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中</h4></blockquote>
<h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><h3 id="客户端于服务端"><a href="#客户端于服务端" class="headerlink" title="客户端于服务端"></a>客户端于服务端</h3><ul>
<li><p>配置中心服务端</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 服务健康管理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- config配置服务 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- eureka客户端 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置中心指定gitHub中文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-service</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/XCW1017/springcloud-config.git</span> <span class="comment">#仓库地址</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">springcloud-config</span>  <span class="comment">#仓库名</span></span><br><span class="line">          <span class="attr">skip-ssl-validation:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">username:</span> <span class="number">2365020142</span><span class="string">@qq.com</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">X15933077087wang</span></span><br><span class="line">           <span class="comment">#选择分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">#rabbitmq相关配置      </span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"><span class="comment">#暴露监控端点    </span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span>  <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;bus-refresh&quot;</span>       </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类开启confingServer</p>
</li>
<li><p>访问<a target="_blank" rel="noopener" href="http://localhost:3344/master/config-dev.yml">http://localhost:3344/master/config-dev.yml</a></p>
</li>
<li><p>客户端</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml指向配置中心服务端</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-client</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">        <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称 </span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span>  <span class="comment">#文件名</span></span><br><span class="line">        <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#读取后缀  ：master分支上config-dev.yml的配置文件被读取</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:3344</span> <span class="comment">#配置服务中心</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rabbitmq相关配置      </span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#暴露监控端点    </span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span>  <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;bus-refresh&quot;</span>    </span><br><span class="line">        </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>controller测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span><span class="comment">//刷新config</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span><span class="comment">//从github配置文件中获取，注入；</span></span><br><span class="line">	String configInfo;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">config</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> configInfo;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="手动刷新"><a href="#手动刷新" class="headerlink" title="手动刷新"></a>手动刷新</h3><ul>
<li><p>必须暴露配置端点</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#暴露监控端点    </span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span>  <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;bus-refresh&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>controller添加@RefreshScope</p>
</li>
<li><p>还需手动打开cmd刷新项目监控：curl -X POST “<a target="_blank" rel="noopener" href="http://localhost:3355/actuator/refrsh&quot;">http://localhost:3355/actuator/refrsh&quot;</a> </p>
</li>
<li><p>才能实现配置的刷新</p>
</li>
</ul>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><h3 id="介绍：-11"><a href="#介绍：-11" class="headerlink" title="介绍："></a>介绍：</h3><blockquote>
<p>动态配置管理是 Nacos 的三大功能之一，通过动态配置服务，我们可以在所有环境中以集中和动态的方式管理所有应用程序或服务的配置信息。</p>
<p>对于spring cloud config 相比：</p>
<p>nacos不需要手动刷新，配置文件放在nacos控制台上访问；</p>
<p>spring cloud config 手动刷新,配置文件在gethub上管理</p>
</blockquote>
<h3 id="使用：-3"><a href="#使用：-3" class="headerlink" title="使用："></a>使用：</h3><ul>
<li><p>pom引入：主要引入nacos-config、nacos依赖、健康健康</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>xml的bootstrap和application文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos服务中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>    <span class="comment">#指定文件类型</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">b75a0be0-ab8e-4918-8c3c-1c5b60aaf5ee</span>  <span class="comment">#命名空间ID</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dev</span> <span class="comment">#开发环境</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">// 刷新nacos</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span><span class="comment">//注入值</span></span><br><span class="line">	<span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">configInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> configInfo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类启动nacos服务注册发现</p>
</li>
<li><p>nacos控制台创建文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: nacos-config-client-dev.yaml,version&#x3D;123</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="注意：-8"><a href="#注意：-8" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>匹配文件为：dataid =  服务名-服务环境.yaml</p>
</blockquote>
<h2 id="Nacos的配置分类"><a href="#Nacos的配置分类" class="headerlink" title="Nacos的配置分类"></a>Nacos的配置分类</h2><ol>
<li><p>active环境切换</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span></span><br><span class="line"><span class="comment">#    - dev #开发环境</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="comment">#测试环境</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>group分组配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos服务中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>    <span class="comment">#指定文件类型</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span></span><br><span class="line"><span class="comment">#        namespace: 1231321  #命名空间ID</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>namespace命名空间配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos服务中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>    <span class="comment">#指定文件类型</span></span><br><span class="line"><span class="comment">#        group: DEV_GROUP</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">b75a0be0-ab8e-4918-8c3c-1c5b60aaf5ee</span>  <span class="comment">#命名空间ID</span></span><br></pre></td></tr></table></figure>












</li>
</ol>
<h2 id="Nacos持久化"><a href="#Nacos持久化" class="headerlink" title="Nacos持久化"></a>Nacos持久化</h2><blockquote>
<p>控制台默认使用derby数据库，改为mysql完成持久化</p>
</blockquote>
<h3 id="本地实现"><a href="#本地实现" class="headerlink" title="本地实现"></a>本地实现</h3><ol>
<li><p>nacos的bin目录下application文件末添加，数据源配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://localhost:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="meta">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">db.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据bin目录下nacos-mysql.sql文件中创建数据库以及表</p>
</li>
</ol>
<h3 id="集群实现"><a href="#集群实现" class="headerlink" title="集群实现"></a>集群实现</h3><blockquote>
<p>环境：下载安装JDK，mysql，nginx，nacos</p>
</blockquote>
<ol>
<li><p>Windows客户端连接linux mysql服务</p>
<p>​    linux 启动mysql服务： <strong>service mysql start</strong></p>
</li>
<li><p>解压nacos，进入conf目录，修改cluster.conf文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.201:3333</span><br><span class="line">192.168.0.201:4444</span><br><span class="line">192.168.0.201:5555</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改nacos的conf下的application.properties文件;(添加数据库配置)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.platform&#x3D;mysql</span><br><span class="line">db.num&#x3D;1</span><br><span class="line">db.url.0&#x3D;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;nacos_config?characterEncoding&#x3D;utf8&amp;connectTimeout&#x3D;1000&amp;socketTimeout&#x3D;3000&amp;autoReconnect&#x3D;true</span><br><span class="line">db.user&#x3D;root</span><br><span class="line">db.password&#x3D;root</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改nacos下bin目录下startup.sh文件，使接受不同启动端口</p>
<ul>
<li><p>大约57-56行，添加信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改前----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;:m:f:s:&quot;</span> opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">        m)</span><br><span class="line">            MODE=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        f)</span><br><span class="line">            FUNCTION_MODE=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        s)</span><br><span class="line">            SERVER=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Unknown parameter&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改后-----------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;:m:f:s:p:&quot;</span> opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">        m)</span><br><span class="line">            MODE=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        f)</span><br><span class="line">            FUNCTION_MODE=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        s)</span><br><span class="line">            SERVER=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        p)</span><br><span class="line">            PORT=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Unknown parameter&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>大约80-90行的，虚拟内存配置 大小改为256m,else中添加JAVA_OPT=”${JAVA_OPT} -Dnacos.server.ip=192.168.0.188”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改前---------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="string">&quot;standalone&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xms512m -Xmx512m -Xmn256m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.standalone=true&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms2g -Xmx2g -Xmn1g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/java_heapdump.hprof&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-UseLargePages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改后--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="string">&quot;standalone&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xmn256m -Xmn256m -Xmn256m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.standalone=true&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/java_heapdump.hprof&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-UseLargePages&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.server.ip=192.168.0.201&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>文件末尾，nohup 行的$JAVA后添加 -Dserver.port</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改前--------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span> &gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line">nohup <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> nacos.nacos &gt;&gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nacos is starting，you can check the <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后--------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span> &gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line">nohup <span class="variable">$JAVA</span> -Dserver.port=<span class="variable">$&#123;PORT&#125;</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> nacos.nacos &gt;&gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nacos is starting，you can check the <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out&quot;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ol>
<ol start="5">
<li><p>nginx配置；修改nginx配置文件 /usr/local/nginx/conf/nginx.conf 文件，添加代理；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#集群代理</span></span><br><span class="line">upstream cluster&#123;</span><br><span class="line">    server 127.0.0.1:3333;</span><br><span class="line">    server 127.0.0.1:4444;</span><br><span class="line">    server 127.0.0.1:5555;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#监听1111端口</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen	1111;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">   		 proxy_pass http://lcluster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="6">
<li><p>启动nginx：</p>
<ul>
<li>方法一：/usr/local/nginx/sbin/nginx  -c  /usr/local/nginx/conf/nginx.conf</li>
<li>方法二：进入/usr/local/nginx/sbin/     执行  ./nginx</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./nginx <span class="comment">#启动</span></span><br><span class="line">./nginx -s reload  <span class="comment">#重启</span></span><br><span class="line">./nginx -s stop  <span class="comment">#停止</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="7">
<li><p>启动nacos：</p>
<ul>
<li><p>进入nacos安装目录下的bin下执行   </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./startup.sh -p 3333    </span><br><span class="line">./startup.sh -p 4444  </span><br><span class="line">./startup.sh -p 5555</span><br><span class="line"></span><br><span class="line">ps -ef |grep nacos  | grep -v grep | wc -l  <span class="comment">#查看nacos启动几个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以在，nacos/logs/start.out 查看启动日志</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ol>
<ol start="8">
<li><p>windows通过nginx访问nacos： <a target="_blank" rel="noopener" href="http://192.168.0.201:1111/nacos">http://192.168.0.201:1111/nacos</a></p>
</li>
<li><p>新建配置，查看是否完成持久化到MySQL中</p>
</li>
<li><p>项目指定nacos地址为虚拟机上</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">      <span class="attr">discovery:</span> </span><br><span class="line"><span class="comment">#        server-addr: localhost:8848</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span><span class="string">:1111</span></span><br></pre></td></tr></table></figure>























</li>
</ol>
<h1 id="6-服务总线Bus"><a href="#6-服务总线Bus" class="headerlink" title="6.    服务总线Bus"></a>6.    服务总线Bus</h1><blockquote>
<p>其会连接微服务系统中所有拥有Bus总线机制的节点，当有数据变更的时候，会通过消息中间件使用消息广播的方式通知所有的微服务节点同步更新数据。目前集成了RabbitMQ和Kafka等消息代理</p>
</blockquote>
<h2 id="6-1-RibbitMQ环境搭建"><a href="#6-1-RibbitMQ环境搭建" class="headerlink" title="6.1  RibbitMQ环境搭建"></a>6.1  RibbitMQ环境搭建</h2><ol>
<li>安装otp_win64_23.0：下载地址<a target="_blank" rel="noopener" href="https://www.erlang.org/downloads">https://www.erlang.org/downloads</a>   <a target="_blank" rel="noopener" href="https://github.com/XCW1017/app/tree/RibbitMQ">https://github.com/XCW1017/app/tree/RibbitMQ</a></li>
<li>执行安装otp_win64_23.0软件   otp_win64_23.0.exe    前提需要安装c++2013，vcredist_x64.exe</li>
<li>配置otp_win64_23.0环境变量 ：path下指向bin目录</li>
<li>cmd 输入命令erl        显示是否安装成功</li>
</ol>
<ol>
<li>安装RibbitMQ 下载地址<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/#getstarted">https://www.rabbitmq.com/#getstarted</a></li>
<li>配置环境变量 ：path下指向sbin目录</li>
<li>启动管理功能：rabbitmq-plugins enable rabbitmq_management</li>
<li>启动RabbitMQ Service -start </li>
<li>进入管理页面： <a target="_blank" rel="noopener" href="http://localhost:15672/">http://localhost:15672/</a>      账户密码默认：guest guest</li>
</ol>
<h2 id="6-2-Bus使用"><a href="#6-2-Bus使用" class="headerlink" title="6.2 Bus使用"></a>6.2 Bus使用</h2><ul>
<li><p>pom引入，监控管理、eureka客户端、rabbitMQ、config客户端</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml暴露监控点，指向</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-client</span></span><br><span class="line"><span class="comment">#config配置中心  </span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">        <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称 </span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span>  <span class="comment">#文件名</span></span><br><span class="line">        <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#读取后缀  ：master分支上config-dev.yml的配置文件被读取</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:3344</span> <span class="comment">#配置服务中心 </span></span><br><span class="line"><span class="comment">#rabbitmq相关配置      </span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"><span class="comment">#暴露监控端点    </span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span>  <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;bus-refresh&quot;</span>    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>只要刷新配置中心，所有客户端都能实现刷新 curl -X POST “<a target="_blank" rel="noopener" href="http://localhost:3344/actuator/bus-refresh&quot;">http://localhost:3344/actuator/bus-refresh&quot;</a></p>
</li>
</ul>
<h3 id="注意：-9"><a href="#注意：-9" class="headerlink" title="注意："></a>注意：</h3><blockquote>
<p>远程连接ribbitmq时，默认账户权限太低需要手动新建账户使用；</p>
<p>默认账户：guest  guest</p>
</blockquote>
<h1 id="7-消息驱动Stream"><a href="#7-消息驱动Stream" class="headerlink" title="7.    消息驱动Stream"></a>7.    消息驱动Stream</h1><h2 id="介绍：-12"><a href="#介绍：-12" class="headerlink" title="介绍："></a>介绍：</h2><blockquote>
<p>在实际开发过程中，服务与服务之间通信经常会使用到消息中间件，而以往使用了哪个中间件比如RabbitMQ，那么该中间件和系统的耦合性就会非常高，如果我们要替换为Kafka那么变动会比较大，这时我们可以使用SpringCloudStream来整合我们的消息中间件，来降低系统和中间件的耦合性</p>
</blockquote>
<table>
<thead>
<tr>
<th>组成</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td>Middleware</td>
<td align="left">中间件，目前只支持RabbitMQ和Kafka</td>
</tr>
<tr>
<td>Binder</td>
<td align="left">Binder是应用与消息中间件之间的封装，目前实行了Kafka和RabbitMQ的Binder，通过Binder可以很方便的连接中间件，可以动态的改变消息类型(对应于Kafka的topic，RabbitMQ的exchange)，这些都可以通过配置文件来实现</td>
</tr>
<tr>
<td>@Input</td>
<td align="left">注解标识输入通道，通过该输入通道接收到的消息进入应用程序</td>
</tr>
<tr>
<td>@Output</td>
<td align="left">注解标识输出通道，发布的消息将通过该通道离开应用程序</td>
</tr>
<tr>
<td>@StreamListener</td>
<td align="left">监听队列，用于消费者的队列的消息接收</td>
</tr>
<tr>
<td>@EnableBinding</td>
<td align="left">指信道channel和exchange绑定在一起</td>
</tr>
</tbody></table>
<h2 id="7-1-Stream的生产者"><a href="#7-1-Stream的生产者" class="headerlink" title="7.1 Stream的生产者"></a>7.1 Stream的生产者</h2><blockquote>
<h5 id="创建springcloud18-stream-ribbitmq-provider-8801-项目"><a href="#创建springcloud18-stream-ribbitmq-provider-8801-项目" class="headerlink" title="创建springcloud18-stream-ribbitmq-provider-8801 项目"></a>创建springcloud18-stream-ribbitmq-provider-8801 项目</h5></blockquote>
<ol>
<li><p>pom引入必须的：eureka客户端，actuator健康监控、stream依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span>  <span class="comment">#端口号</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span> <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment">#在此处配置要绑定的rabbitmq的服务信息</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment">#表示定义的名称，用于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment">#消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment">#设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span> </span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment">#服务的整合处理</span></span><br><span class="line">        <span class="attr">output:</span> <span class="comment">#这个名字是一个通道名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment">#表示要使用Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment">#设置消息类型，本次为json，文本则设置为text/plain</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span> <span class="comment">#设置要绑定的消息服务的具体设置</span></span><br><span class="line">   </span><br><span class="line"><span class="attr">eureka:</span> </span><br><span class="line">  <span class="comment"># 每个EurekaServer 都包含一个EurekaClient，用于请求其他节同步 </span></span><br><span class="line">  <span class="attr">client:</span> </span><br><span class="line">  <span class="comment">#表示是否将自己注册EurekaServer</span></span><br><span class="line">     <span class="attr">registerWithEureka:</span> <span class="literal">true</span> </span><br><span class="line">     <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true，单节点无所谓，集群必须设置为true才能配合ribbn使用负载均衡</span></span><br><span class="line">     <span class="attr">fetchRegistry:</span> <span class="literal">true</span> </span><br><span class="line">     <span class="attr">service-url:</span> </span><br><span class="line">     <span class="comment">#设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址，如果服务器是集群就用    ， 号分割地址</span></span><br><span class="line">       <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br><span class="line"><span class="comment">#     eureka-server-connect-timeout-seconds: 60</span></span><br><span class="line"><span class="comment">#     eureka-server-read-timeout-seconds: 60</span></span><br><span class="line">     </span><br><span class="line">  <span class="attr">instance:</span> </span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#是否将自己IP地址注册到Eureka</span></span><br><span class="line">    <span class="attr">ip-address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="comment"># 指定实例名称，默认：$&#123;spring.cloud.client.hostname&#125;:$&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;&#125;  </span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;server.port&#125;</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">30</span> <span class="comment">#Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒，默认90秒，超时将剔除服务</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">10</span> <span class="comment">#Eureka客户端向服务端发送心跳的时间间隔单位为秒默认30秒</span></span><br><span class="line"><span class="comment">#    leaserenewalintervalinseconds: 10 #心跳时间</span></span><br><span class="line">        </span><br><span class="line">          </span><br><span class="line">      </span><br></pre></td></tr></table></figure>
</li>
<li><p>业务类定义接口并实现接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SendMessage</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">sendMessage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Source;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.MessageChannel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.support.MessageBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xcw.service.SendMessage;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span><span class="comment">//定义消息的推送管道</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageImpl</span> <span class="keyword">implements</span> <span class="title">SendMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> MessageChannel output = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">sendMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String serial = UUID.randomUUID().toString();</span><br><span class="line">		output.send(MessageBuilder.withPayload(serial).build());<span class="comment">//发送消息到MQ</span></span><br><span class="line">		<span class="keyword">return</span> serial;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xcw.service.SendMessage;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> SendMessage sendMessage;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/send&quot;)</span> <span class="comment">//访问该映射发送消息</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sendMessage.sendMessage();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动访问地址发送消息： <a target="_blank" rel="noopener" href="http://localhost:8801/send">http://localhost:8801/send</a></p>
<p><img src="C:\Users\Administrator\Desktop\tarminal.assets\image-20201022183731066.png" alt="image-20201022183731066"></p>
</li>
</ol>
<h2 id="7-2-Stream消费者"><a href="#7-2-Stream消费者" class="headerlink" title="7.2 Stream消费者"></a>7.2 Stream消费者</h2><blockquote>
<p>新建项目：springcloud19-stream-ribbitmq-consumerr-8802</p>
</blockquote>
<ol>
<li><p>pom引入：actuator监控管理、eureka客户端、stream</p>
</li>
<li><pre><code class="xml">&lt;dependency&gt;
             &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
             &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
         &lt;/dependency&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
         &lt;/dependency&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-stream&lt;/artifactId&gt;
         &lt;/dependency&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-stream-binder-rabbit&lt;/artifactId&gt;
         &lt;/dependency&gt;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3. yml配置：8802</span><br><span class="line"></span><br><span class="line">   &#96;&#96;&#96;yml</span><br><span class="line">   server:</span><br><span class="line">     port: 8802  #端口号</span><br><span class="line">   </span><br><span class="line">   spring: </span><br><span class="line">     application:</span><br><span class="line">       name: cloud-stream-consumer #服务名称</span><br><span class="line">     cloud:</span><br><span class="line">       stream:</span><br><span class="line">         binders: #在此处配置要绑定的rabbitmq的服务信息</span><br><span class="line">           defaultRabbit: #表示定义的名称，用于binding整合</span><br><span class="line">             type: rabbit #消息组件类型</span><br><span class="line">             environment: #设置rabbitmq的相关的环境配置</span><br><span class="line">               spring:</span><br><span class="line">                 rabbitmq: </span><br><span class="line">                   host: localhost</span><br><span class="line">                   port: 5672</span><br><span class="line">                   username: guest</span><br><span class="line">                   password: guest</span><br><span class="line">         bindings: #服务的整合处理</span><br><span class="line">           input: #这个名字是一个通道名称</span><br><span class="line">             destination: studyExchange #表示要使用Exchange名称定义</span><br><span class="line">             content-type: application&#x2F;json #设置消息类型，本次为json，文本则设置为text&#x2F;plain</span><br><span class="line">             binder: defaultRabbit #设置要绑定的消息服务的具体设置</span><br><span class="line">   #          group: xcwA      </span><br><span class="line">      </span><br><span class="line">   eureka: </span><br><span class="line">     # 每个EurekaServer 都包含一个EurekaClient，用于请求其他节同步 </span><br><span class="line">     client: </span><br><span class="line">     #表示是否将自己注册EurekaServer</span><br><span class="line">        registerWithEureka: true </span><br><span class="line">        #是否从EurekaServer抓取已有的注册信息，默认为true，单节点无所谓，集群必须设置为true才能配合ribbn使用负载均衡</span><br><span class="line">        fetchRegistry: true </span><br><span class="line">        service-url: </span><br><span class="line">        #设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址，如果服务器是集群就用    ， 号分割地址</span><br><span class="line">          defaultZone: http:&#x2F;&#x2F;localhost:7001&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;localhost:7002&#x2F;eureka&#x2F;</span><br><span class="line">   #     eureka-server-connect-timeout-seconds: 60</span><br><span class="line">   #     eureka-server-read-timeout-seconds: 60</span><br><span class="line">        </span><br><span class="line">     instance: </span><br><span class="line">       prefer-ip-address: true #是否将自己IP地址注册到Eureka</span><br><span class="line">       ip-address: 127.0.0.1</span><br><span class="line">       # 指定实例名称，默认：$&#123;spring.cloud.client.hostname&#125;:$&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;&#125;  </span><br><span class="line">       instance-id: $&#123;spring.application.name&#125;:$&#123;server.port&#125;</span><br><span class="line">       lease-expiration-duration-in-seconds: 30 #Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒，默认90秒，超时将剔除服务</span><br><span class="line">       lease-renewal-interval-in-seconds: 10 #Eureka客户端向服务端发送心跳的时间间隔单位为秒默认30秒</span><br><span class="line">   #    leaserenewalintervalinseconds: 10 #心跳时间</span><br></pre></td></tr></table></figure></code></pre>
</li>
<li><p>创建监听类，linstener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xcw.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@StreamListener(Sink.INPUT)</span><span class="comment">//监听配置中的消息名;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">input</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;消费者1号，-------》接收到消息：&quot;</span> + message.getPayload() + <span class="string">&quot;\t port:&quot;</span> + serverPort);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>








</li>
</ol>
<h2 id="7-3-Stream持久化设置"><a href="#7-3-Stream持久化设置" class="headerlink" title="7.3 Stream持久化设置"></a>7.3 Stream持久化设置</h2><blockquote>
<h3 id="上述设置我们的消费者，在生产者发送消息后，消费者启动无法获取消息，所以为实现消息持久化需要配置为组"><a href="#上述设置我们的消费者，在生产者发送消息后，消费者启动无法获取消息，所以为实现消息持久化需要配置为组" class="headerlink" title="上述设置我们的消费者，在生产者发送消息后，消费者启动无法获取消息，所以为实现消息持久化需要配置为组;"></a>上述设置我们的消费者，在生产者发送消息后，消费者启动无法获取消息，所以为实现消息持久化需要配置为组;</h3></blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span> <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment">#在此处配置要绑定的rabbitmq的服务信息</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment">#表示定义的名称，用于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment">#消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment">#设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span> </span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment">#服务的整合处理</span></span><br><span class="line">        <span class="attr">input:</span> <span class="comment">#这个名字是一个通道名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment">#表示要使用Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment">#设置消息类型，本次为json，文本则设置为text/plain</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span> <span class="comment">#设置要绑定的消息服务的具体设置</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">xcwA</span>  	<span class="comment">#设置消息属于的组，组相同可以解决重复消费的问题</span></span><br></pre></td></tr></table></figure>





<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(Sink.class)</span>  <span class="comment">//绑定消息通道</span></span><br><span class="line"><span class="meta">@StreamListener(Sink.INPUT)</span><span class="comment">//监听配置中的消息名;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="8-链路跟踪"><a href="#8-链路跟踪" class="headerlink" title="8.    链路跟踪"></a>8.    链路跟踪</h1><h2 id="介绍：-13"><a href="#介绍：-13" class="headerlink" title="介绍："></a>介绍：</h2><blockquote>
<p> 在一个完整的微服务架构项目中，服务之间的调用是很复杂的，当其中某一个服务出现了问题或者访问超时，很</p>
<p> 难直接确定是由哪个服务引起的，所以就有了 Spring Cloud Sleuth 链路跟踪。通过它，我们就可以很清楚直观</p>
<p> 的了解每一个服务请求经过了哪些服务，用时多久，谁依赖谁或者被谁依赖</p>
</blockquote>
<h2 id="zipkin服务"><a href="#zipkin服务" class="headerlink" title="zipkin服务"></a>zipkin服务</h2><ol>
<li><p>在浏览器中访问 <a target="_blank" rel="noopener" href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/%EF%BC%88%E6%88%91%E4%B8%8B%E8%BD%BD%E4%BA%862.12.9%EF%BC%89">https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/（我下载了2.12.9）</a></p>
</li>
<li><p>选择路径下载保存到本地（我保存到了桌面）</p>
</li>
<li><p>等待下载结束后，打开 cmd</p>
</li>
<li><p>输入命令 <strong>cd desktop</strong> -&gt; 进入到桌面</p>
</li>
<li><p>输入命令 <strong>java -jar zipkin.jar</strong> -&gt; 执行 jar 包，zipkin.jar 就是上面自动下载的 jar 包</p>
</li>
<li><p>启动成功后访问：<a target="_blank" rel="noopener" href="http://localhost:9411/">http://localhost:9411</a> 即可看到 Zipkin Server 主页面</p>
</li>
<li><p>SpringCloud的F/2.x版本起，不在需要安装客户端，只需要调用jar包</p>
</li>
</ol>
<h2 id="使用：-4"><a href="#使用：-4" class="headerlink" title="使用："></a>使用：</h2><ul>
<li><p>生产者消费者引入zipkin依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml配置zipkin地址，和检索率</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-panment-service</span> <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span>  </span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span> <span class="comment">#采样率值介于0 到 1之间，1表示全部采集</span></span><br></pre></td></tr></table></figure>





</li>
</ul>
<h2 id="注意：-10"><a href="#注意：-10" class="headerlink" title="注意："></a>注意：</h2><blockquote>
<p>sleuth采样率，默认为0.1，值越大收集越及时，但性能影响也越大</p>
</blockquote>
<h1 id="9-Alibaba"><a href="#9-Alibaba" class="headerlink" title="9. Alibaba"></a>9. Alibaba</h1><p>​        官网介绍：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-alibaba#overview">https://spring.io/projects/spring-cloud-alibaba#overview</a></p>
<p>​        中文官网： <a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p>​        nacos官网：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/quick-start.html">https://nacos.io/zh-cn/docs/quick-start.html</a></p>
<h1 id="10-seata分布式事务"><a href="#10-seata分布式事务" class="headerlink" title="10.    seata分布式事务"></a>10.    seata分布式事务</h1><blockquote>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/seata/seata/tags">https://github.com/seata/seata/tags</a></p>
<p>中文文档：<a target="_blank" rel="noopener" href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">http://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p>
</blockquote>
<h2 id="seata环境配置"><a href="#seata环境配置" class="headerlink" title="seata环境配置"></a>seata环境配置</h2><ol>
<li><p>修改conf目录下file.conf文件：</p>
<p>​    service下组名改为fsp_tx_group</p>
<p>​    store下mode属性=db</p>
<p>​    db属性配置用户名密码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">service &#123;</span><br><span class="line">  #vgroup-&gt;rgroup</span><br><span class="line">  vgroup_mapping.my_test_tx_group = &quot;fsp_tx_group&quot;</span><br><span class="line">  #only support single node</span><br><span class="line">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br><span class="line">  #degrade current not support</span><br><span class="line">  enableDegrade = false</span><br><span class="line">  #disable</span><br><span class="line">  disable = false</span><br><span class="line">  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span><br><span class="line">  max.commit.retry.timeout = &quot;-1&quot;</span><br><span class="line">  max.rollback.retry.timeout = &quot;-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">store &#123;</span><br><span class="line">  ## store mode: file、db</span><br><span class="line">  mode = &quot;db&quot;</span><br><span class="line"></span><br><span class="line">  ## database store</span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource = &quot;dbcp&quot;</span><br><span class="line">    ## mysql/oracle/h2/oceanbase etc.</span><br><span class="line">    db-type = &quot;mysql&quot;</span><br><span class="line">    driver-class-name = &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    url = &quot;jdbc:mysql://127.0.0.1:3306/seata&quot;</span><br><span class="line">    user = &quot;root&quot;</span><br><span class="line">    password = &quot;root&quot;</span><br><span class="line">    min-conn = 1</span><br><span class="line">    max-conn = 3</span><br><span class="line">    global.table = &quot;global_table&quot;</span><br><span class="line">    branch.table = &quot;branch_table&quot;</span><br><span class="line">    lock-table = &quot;lock_table&quot;</span><br><span class="line">    query-limit = 100</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>新增数据库为seata，执行conf目录下的db_store.sql文件</p>
</li>
<li><p>修改conf目录下registry.conf文件：</p>
<p>​    registry下的type改为nacos</p>
<p>​    nacos下的serverAddr属性指向服务中心localhost:8848</p>
</li>
<li><p>双击bin目录下seata-server.bat文件启动</p>
</li>
</ol>
<h1 id="10-版本问题"><a href="#10-版本问题" class="headerlink" title="10.    版本问题"></a>10.    版本问题</h1><blockquote>
<h5 id="spring-boot版本查询：-https-mvnrepository-com-artifact-org-springframework-boot-spring-boot-dependencies"><a href="#spring-boot版本查询：-https-mvnrepository-com-artifact-org-springframework-boot-spring-boot-dependencies" class="headerlink" title="spring boot版本查询： https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-dependencies"></a>spring boot版本查询： <a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-dependencies">https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-dependencies</a></h5></blockquote>
<blockquote>
<h5 id="spring-cloud版本查询：https-mvnrepository-com-artifact-org-springframework-cloud-spring-cloud-dependencies"><a href="#spring-cloud版本查询：https-mvnrepository-com-artifact-org-springframework-cloud-spring-cloud-dependencies" class="headerlink" title="spring cloud版本查询：https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies"></a>spring cloud版本查询：<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies">https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies</a></h5></blockquote>
<blockquote>
<h5 id="根据spring-cloud-选择Boot-https-start-spring-io-actuator-info"><a href="#根据spring-cloud-选择Boot-https-start-spring-io-actuator-info" class="headerlink" title="根据spring cloud 选择Boot https://start.spring.io/actuator/info"></a>根据spring cloud 选择Boot <a target="_blank" rel="noopener" href="https://start.spring.io/actuator/info">https://start.spring.io/actuator/info</a></h5></blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/12/07/github搭建个人博客/" title="GitHub+hexo搭建个人博客" itemprop="url">GitHub+hexo搭建个人博客</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="小饼干" target="_blank" itemprop="author">小饼干</a>
		
  <p class="article-time">
    <time datetime="2020-12-07T09:23:36.369Z" itemprop="datePublished"> Published 2020-12-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="1-安装node环境"><a href="#1-安装node环境" class="headerlink" title="1.安装node环境"></a>1.安装node环境</h2><p>首先我们在本机要安装Node环境，我们可以直接来到Node.js官网：<a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a></p>
<p>下载后，直接双击，然后就是一直下一步下一步的傻瓜式操作。这里要注意的是：<strong>有的人的电脑可能已经安装好Node环境，已经安装好的可以通过在cmd窗口执行下面的命令查看Node版本</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>



<h2 id="2-安装Git环境"><a href="#2-安装Git环境" class="headerlink" title="2.安装Git环境"></a>2.安装Git环境</h2><p>Git官网下载：<code>https://git-scm.com/downloads</code></p>
<h2 id="3-安装hexo"><a href="#3-安装hexo" class="headerlink" title="3.安装hexo"></a>3.安装hexo</h2><p>新建文件夹MyBlog</p>
<p>在E:\MyBlog目录下，右击打开<code>Git Bash</code>，接着在Gir Bash中执行：<code>npm install -g hexo</code>命令，当看到下图所示表示安装完成，第一次可能等的时间会比较长</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207173224.png" alt="image-20201207173224759"></p>
<p>执行 <code>hexo init</code> 初始化项目； </p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207173244.png" alt="image-20201207173243982"></p>
<p>初始化成功后根目录下会生成相关文件；</p>
<ol>
<li><strong>source</strong>：该文件夹是存放我们自己文章的地方，文章存放在该目录下的_posts文件夹中。</li>
<li><strong>themes</strong>：用于存放博客的主题信息。</li>
<li><strong>_config.yml</strong>：是hexo博客的配置文件，很多配置信息都在这里面。</li>
</ol>
<p>接下来执行：<code>npm install</code>和<code>hexo g</code>，使用<strong>npm源安装所依赖的组件和编译生成静态页面</strong>。</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207173512.png" alt="image-20201207173512224"></p>
<p>执行完成后根目录会生成 <code>public</code>文件夹，该文件夹用于存放静态页面</p>
<p>启动hexo执行命令 <code>hexo s</code>，会告诉你浏览器访问<code>http://localhost:4000</code>搭建成功</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/12/07/vue-use/" title="Vue使用" itemprop="url">Vue使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="小饼干" target="_blank" itemprop="author">小饼干</a>
		
  <p class="article-time">
    <time datetime="2020-12-07T08:26:19.469Z" itemprop="datePublished"> Published 2020-12-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="vue安装"><a href="#vue安装" class="headerlink" title="vue安装"></a>vue安装</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liluxiang/p/9592003.html">https://www.cnblogs.com/liluxiang/p/9592003.html</a></p>
<p>安装vue之前，先安装node，node中包含一个npm</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查看node版本</span><br><span class="line">node -v</span><br><span class="line">#查看npm版本</span><br><span class="line">npm -v</span><br><span class="line">#安装vue-cli（--global 意思是全局安装  这羊Vue会安装到 安装node 的文件夹下 否则会安装到 当前目录）</span><br><span class="line">npm install --<span class="built_in">global</span> vue-cli</span><br><span class="line">#查看vue版本号</span><br><span class="line">vue --version</span><br><span class="line">vue -V</span><br></pre></td></tr></table></figure>



<h2 id="创建vue项目"><a href="#创建vue项目" class="headerlink" title="创建vue项目"></a>创建vue项目</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#创建一个基于webpack模板的项目（vue01项目文件夹）</span><br><span class="line">vue init webpack vue01</span><br><span class="line">	#成功后填写项目属性；</span><br><span class="line">    Project name 项目名称</span><br><span class="line">    Project description 项目描述</span><br><span class="line">    Author 作者</span><br><span class="line">    vue-router yes 其余选择否</span><br><span class="line">    #should we run npm install.... (是否在工程创建后就去跑 npm 安装依赖 第一个是【是】 最后一个 稍后自己就安装依赖 即 在命令行执行npm install 命令 )</span><br><span class="line"></span><br><span class="line">#安装项目依赖</span><br><span class="line">cd vue01</span><br><span class="line">npm install</span><br><span class="line">#启动项目，默认地址http://localhost:8080/</span><br><span class="line">npm run dev</span><br><span class="line">#项目打包，根目录生成dist文件夹，生成静态页面</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>



<p>执行 npm  run build 会打包生成dist，直接访问则一片空白，这是因为引用资源路径问题；</p>
<p>我们修改项目目录下config文件夹的index.js文件，重新打包；</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207162552.png" alt="image-20201203105020336"></p>
<h2 id="idea导入vue项目"><a href="#idea导入vue项目" class="headerlink" title="idea导入vue项目"></a>idea导入vue项目</h2><h3 id="1-首先创建npm服务器"><a href="#1-首先创建npm服务器" class="headerlink" title="1.首先创建npm服务器"></a>1.首先创建npm服务器</h3><p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207162552.png" alt="image-20201203113725765"></p>
<h3 id="2-启动项目"><a href="#2-启动项目" class="headerlink" title="2.启动项目"></a>2.启动项目</h3><p>会显示访问路径</p>
<h2 id="新建VUE页面"><a href="#新建VUE页面" class="headerlink" title="新建VUE页面"></a>新建VUE页面</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;!--静态内容，View部分--&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">&#x2F;&#x2F;静态内容，Model和vm部分</span><br><span class="line"></span><br><span class="line">    export default &#123;</span><br><span class="line">        name: &quot;module.xcw.api.HelloWord&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">&#x2F;*页面样式，不是必须*&#x2F;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>




        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/12/07/本地项目上传到gitee/" title="本地项目上传到gitee" itemprop="url">本地项目上传到gitee</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="小饼干" target="_blank" itemprop="author">小饼干</a>
		
  <p class="article-time">
    <time datetime="2020-12-07T08:21:44.546Z" itemprop="datePublished"> Published 2020-12-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="1-本地仓库先执行初始化"><a href="#1-本地仓库先执行初始化" class="headerlink" title="1.本地仓库先执行初始化"></a>1.本地仓库先执行初始化</h2><p>在项目中打开git命令框输入 <strong>git init</strong>，会发现文件夹中生成了.git文件夹说明初始化成功</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207123157.png" alt="image-20201207110509533"></p>
<h2 id="2-建立远程仓库"><a href="#2-建立远程仓库" class="headerlink" title="2.建立远程仓库"></a>2.建立远程仓库</h2><p>新建一个远程仓库</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207123205.png" alt="image-20201207110908992"></p>
<h2 id="3-建立连接"><a href="#3-建立连接" class="headerlink" title="3.建立连接"></a>3.建立连接</h2><p>复制链接并在本地输入命令 git remote origin master 仓库链接</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207123211.png" alt="image-20201207111438162"></p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207123217.png" alt="image-20201207112620751"></p>
<h2 id="4-上传项目"><a href="#4-上传项目" class="headerlink" title="4.上传项目"></a>4.上传项目</h2><blockquote>
<p>注意：若新建仓库时勾选了，Readme文件初始化，要先执行 git pull origin master</p>
</blockquote>
<p>git add .     将文件放入缓存区；git add . 代表放入所有 git add [文件名]代表放入指定文件</p>
<p>git commit -m “文件描述”  将缓存区发送到本地仓库</p>
<p>git push -u origin master 将本地仓库推送到远程仓库</p>
<p><img src="https://gitee.com/wwwblog/images/raw/master/imgs/20201207123221.png" alt="image-20201207113801017"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="https://github.com/wwblog" data-theme="medium"></div>
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>



  

  

  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://wwblog.github.io/2020/12/07/%E6%9C%AC%E5%9C%B0%E9%A1%B9%E7%9B%AE%E4%B8%8A%E4%BC%A0%E5%88%B0gitee/" target="_blank" title="本地项目上传到gitee">本地项目上传到gitee</a>
            
          </li>
        
          <li>
            
            	<a href="https://wwblog.github.io/2020/12/08/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID/" target="_blank" title="全局唯一ID">全局唯一ID</a>
            
          </li>
        
          <li>
            
            	<a href="https://wwblog.github.io/2020/12/08/SpringCloud/" target="_blank" title="SpringCloud">SpringCloud</a>
            
          </li>
        
          <li>
            
            	<a href="https://wwblog.github.io/2020/12/07/github%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" target="_blank" title="GitHub+Hexo搭建个人博客">GitHub+Hexo搭建个人博客</a>
            
          </li>
        
          <li>
            
            	<a href="https://wwblog.github.io/2020/12/07/vue-use/" target="_blank" title="Vue使用">Vue使用</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 程序员上辈子都是折翼的天使 <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/6189300786" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/wwblog" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="小饼干">小饼干</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
